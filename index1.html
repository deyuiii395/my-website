<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜33ç­å…­æ¬¡è”è€ƒæˆç»©æ™ºèƒ½åˆ†æç³»ç»Ÿ (V7.0 å…¨åŠŸèƒ½ç‰ˆ)</title>
    
    <!-- æ ¸å¿ƒåº“ CDN -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/recharts@2.8.0/umd/Recharts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.17/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; color: #1e293b; }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        
        /* è¡¨æ ¼å›ºå®šè¡¨å¤´ */
        .sticky-header th { position: sticky; top: 0; z-index: 10; }

        /* æ‰“å°ä¸“ç”¨æ ·å¼ */
        @media print {
            @page { size: A4; margin: 0; }
            html, body { width: 210mm; height: 100%; margin: 0; padding: 0; background: white; font-family: 'SimSun', 'Songti SC', serif; color: black; -webkit-print-color-adjust: exact; font-weight: bold; } 
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            
            .print-container { width: 100%; margin: 0; padding: 0; }
            .print-group { break-after: page; page-break-after: always; }
            .print-group:last-child { break-after: auto; page-break-after: auto; }
            
            /* æ¯ä¸€é¡µå¼ºåˆ¶é«˜åº¦ï¼Œé˜²æ­¢æº¢å‡º */
            .print-page { 
                width: 210mm; 
                height: 296mm; /* A4 é«˜åº¦ 297mmï¼Œç•™1mmå®¹é”™ */
                position: relative; 
                overflow: hidden; 
                padding: 15mm 10mm;
                box-sizing: border-box;
            }
            .print-page-1 { page-break-after: always; }
            .recharts-wrapper { margin: 0 auto; visibility: visible !important; }
            h1, h2, h3, h4, th, td, p, span, div, li { font-weight: bold !important; }
            table { border-collapse: collapse; width: 100%; }
            table, th, td { border: 1px solid #000 !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const RechartsLib = window.Recharts || {
            LineChart: () => null, Line: () => null, XAxis: () => null, YAxis: () => null, 
            CartesianGrid: () => null, Tooltip: () => null, Legend: () => null, LabelList: () => null,
            ResponsiveContainer: ({children}) => <div>{children}</div>, 
            BarChart: () => null, Bar: () => null, ReferenceLine: () => null 
        };
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, LabelList, ResponsiveContainer, BarChart, Bar, ReferenceLine } = RechartsLib;

        // --- Icons ---
        const Icons = {
            Printer: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>,
            Upload: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>,
            Settings: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            ChevronLeft: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            Check: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Trophy: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            TrendingUp: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            FileText: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg>,
            Search: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Users: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Activity: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            BookOpen: (p) => <svg {...p} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
        };

        // --- Configuration ---
        const EXAM_CONFIG = [
            { id: 0, name: "â‘  8æœˆè”è€ƒ", defaultSpecial: 413, defaultBachelor: 371, defaultSubs: { è¯­æ–‡:82, æ•°å­¦:82, è‹±è¯­:82, ç‰©ç†:55, åŒ–å­¦:55, ç”Ÿç‰©:55, æ”¿æ²»:55, å†å²:55, åœ°ç†:55 } },
            { id: 1, name: "â‘¡ 9æœˆè”è€ƒ", defaultSpecial: 454, defaultBachelor: 375.5, defaultSubs: { è¯­æ–‡:90, æ•°å­¦:90, è‹±è¯­:90, ç‰©ç†:60, åŒ–å­¦:60, ç”Ÿç‰©:60, æ”¿æ²»:60, å†å²:60, åœ°ç†:60 } },
            { id: 2, name: "â‘¢ 10æœˆè”è€ƒ", defaultSpecial: 421, defaultBachelor: 373, defaultSubs: { è¯­æ–‡:84, æ•°å­¦:84, è‹±è¯­:84, ç‰©ç†:56, åŒ–å­¦:56, ç”Ÿç‰©:56, æ”¿æ²»:56, å†å²:56, åœ°ç†:56 } },
            { id: 3, name: "â‘£ 12æœˆ(1)è”è€ƒ", defaultSpecial: 424, defaultBachelor: 352, defaultSubs: { è¯­æ–‡:85, æ•°å­¦:85, è‹±è¯­:85, ç‰©ç†:57, åŒ–å­¦:57, ç”Ÿç‰©:57, æ”¿æ²»:57, å†å²:57, åœ°ç†:57 } },
            { id: 4, name: "â‘¤ 12æœˆ(2)è”è€ƒ", defaultSpecial: 412, defaultBachelor: 365, defaultSubs: { è¯­æ–‡:82, æ•°å­¦:82, è‹±è¯­:82, ç‰©ç†:55, åŒ–å­¦:55, ç”Ÿç‰©:55, æ”¿æ²»:55, å†å²:55, åœ°ç†:55 } },
            { id: 5, name: "â‘¥ 1æœˆä¸€æ¨¡", defaultSpecial: 446, defaultBachelor: 385, defaultSubs: { è¯­æ–‡:89, æ•°å­¦:89, è‹±è¯­:89, ç‰©ç†:59, åŒ–å­¦:59, ç”Ÿç‰©:59, æ”¿æ²»:59, å†å²:59, åœ°ç†:59 } },
        ];
        const SUBJECTS = ['è¯­æ–‡', 'æ•°å­¦', 'è‹±è¯­', 'ç‰©ç†', 'åŒ–å­¦', 'ç”Ÿç‰©', 'æ”¿æ²»', 'å†å²', 'åœ°ç†'];
        const COLORS = ["#ef4444", "#f97316", "#f59e0b", "#10b981", "#06b6d4", "#3b82f6", "#6366f1", "#8b5cf6", "#d946ef"];
        
        // Demo data
        const DEMO_STUDENTS = [{
            name: "ææ¬£", id: "230493",
            scores: [
                { examId: 0, total: 442.5, rank: 1, gradeRank: 69, subjects: { è¯­æ–‡: 109, æ•°å­¦: 58, è‹±è¯­: 83.5, ç‰©ç†: 26, åŒ–å­¦: 75, åœ°ç†: 91 } }, 
                { examId: 1, total: 434.5, rank: 1, gradeRank: 237, subjects: { è¯­æ–‡: 91.5, æ•°å­¦: 54, è‹±è¯­: 96, ç‰©ç†: 30, åŒ–å­¦: 71, åœ°ç†: 92 } }, 
                { examId: 2, total: 392.5, rank: 3, gradeRank: 316, subjects: { è¯­æ–‡: 94.5, æ•°å­¦: 50, è‹±è¯­: 90, ç‰©ç†: 20, åŒ–å­¦: 60, åœ°ç†: 78 } }, 
                { examId: 3, total: 414, rank: 3, gradeRank: 172, subjects: { è¯­æ–‡: 91.5, æ•°å­¦: 60, è‹±è¯­: 95, ç‰©ç†: 35, åŒ–å­¦: 65, åœ°ç†: 67.5 } }, 
                { examId: 4, total: 400, rank: 4, gradeRank: 200, subjects: { è¯­æ–‡: 90, æ•°å­¦: 55, è‹±è¯­: 92, ç‰©ç†: 28, åŒ–å­¦: 70, åœ°ç†: 65 } }, 
                { examId: 5, total: 477.5, rank: 1, gradeRank: 101, subjects: { è¯­æ–‡: 103, æ•°å­¦: 66, è‹±è¯­: 102.5, ç‰©ç†: 43, åŒ–å­¦: 73, åœ°ç†: 90 } }
            ] 
        }];

        // --- Logic: æ™ºèƒ½è¯Šæ–­ï¼ˆå½’å› =ç­å‡/æ ‡å‡†å·®å¯¹æ¯”ï¼›ç§‘ç›®å»ºè®®=åˆ†ç§‘åˆ†åŸºç¡€ï¼‰---
        const SUBJECT_ADVICE_MAP = {
            è¯­æ–‡: { weak: "åŠ å¼ºé˜…è¯»ä¸å¤è¯—æ–‡ç§¯ç´¯ï¼Œä½œæ–‡æ³¨é‡å®¡é¢˜ä¸ç»“æ„ï¼›å»ºè®®å»ºç«‹ç´ ææœ¬ä¸é”™é¢˜å½’çº³ã€‚", normal: "ä¿æŒé˜…è¯»é‡ï¼Œå¼ºåŒ–å¤è¯—æ–‡ä¸è®ºè¿°ç±»æ–‡æœ¬ï¼›ä½œæ–‡å¯é’ˆå¯¹æ€§ç»ƒå®¡é¢˜ä¸ç«‹æ„ã€‚", strong: "ä¿æŒç°æœ‰ä¼˜åŠ¿ï¼Œå¯å†²åˆºé«˜åˆ†ä½œæ–‡ä¸é˜…è¯»æ»¡åˆ†ï¼›æ³¨æ„å·é¢ä¸æ—¶é—´åˆ†é…ã€‚" },
            æ•°å­¦: { weak: "å¼ºåŒ–è®¡ç®—å‡†ç¡®ç‡ä¸å®¡é¢˜ä¹ æƒ¯ï¼Œå…ˆæŠ“ä¸­æ¡£é¢˜ï¼›å»ºè®®æ¯æ—¥é™æ—¶ç»ƒåŸºç¡€é¢˜ä¸é”™é¢˜é‡åšã€‚", normal: "å·©å›ºä¸­æ¡£é¢˜ï¼Œçªç ´é€‰å¡«å‹è½´ï¼›æ³¨æ„æ­¥éª¤è§„èŒƒä¸æ—¶é—´åˆ†é…ã€‚", strong: "å¯æ”»å…³å‹è½´é¢˜ä¸åˆ›æ–°é¢˜ï¼›ä¿æŒæ‰‹æ„Ÿï¼Œæ³¨æ„è€ƒåœºå¿ƒæ€ä¸æ—¶é—´åˆ†é…ã€‚" },
            è‹±è¯­: { weak: "å¤¯å®è¯æ±‡ä¸é•¿éš¾å¥ï¼Œå¬åŠ›ä¸å†™ä½œåˆ†é¡¹çªç ´ï¼›å»ºè®®æ¯æ—¥é˜…è¯»ä¸å¬åŠ›è¾“å…¥ã€‚", normal: "å¼ºåŒ–é˜…è¯»é€Ÿåº¦ä¸å®Œå½¢é€»è¾‘ï¼›ä½œæ–‡å¯ç§¯ç´¯å¥å¼ä¸èŒƒæ–‡ã€‚", strong: "ä¿æŒé˜…è¯»ä¸å¬åŠ›è¾“å…¥ï¼›ä½œæ–‡å¯è¿½æ±‚äº®ç‚¹è¡¨è¾¾ä¸å·é¢ã€‚" },
            ç‰©ç†: { weak: "ä»å—åŠ›ä¸è¿åŠ¨åˆ†æå…¥æ‰‹ï¼Œåƒé€åŸºæœ¬æ¨¡å‹ä¸å…¬å¼ï¼›å»ºè®®ç”»å›¾åˆ†æã€è§„èŒƒåˆ—å¼ã€‚", normal: "å·©å›ºå…¸å‹æ¨¡å‹ä¸å®éªŒé¢˜ï¼›åŠ å¼ºç»¼åˆé¢˜æ‹†è§£ä¸è®¡ç®—ã€‚", strong: "å¯çªç ´ç»¼åˆé¢˜ä¸åˆ›æ–°æƒ…å¢ƒï¼›æ³¨æ„å®éªŒé¢˜è¡¨è¿°ä¸å•ä½è§„èŒƒã€‚" },
            åŒ–å­¦: { weak: "æŠ“ç‰¢æ–¹ç¨‹å¼ä¸åŸºæœ¬æ¦‚å¿µï¼Œé‡è§†è¯¾æœ¬å®éªŒä¸æµç¨‹ï¼›å»ºè®®åˆ†ä¸“é¢˜çªç ´æœ‰æœºä¸è®¡ç®—ã€‚", normal: "å·©å›ºå·¥ä¸šæµç¨‹ä¸å®éªŒæ¢ç©¶ï¼›å¼ºåŒ–æœ‰æœºæ¨æ–­ä¸è®¡ç®—é¢˜ã€‚", strong: "å¯å†²åˆºå·¥ä¸šæµç¨‹ä¸æœ‰æœºç»¼åˆï¼›æ³¨æ„è¡¨è¿°è§„èŒƒä¸é™·é˜±è¯†åˆ«ã€‚" },
            ç”Ÿç‰©: { weak: "å¼ºåŒ–æ¦‚å¿µè¾¨æä¸æ•™æè¡¨è¿°ï¼Œé—ä¼ ä¸å®éªŒè®¾è®¡åˆ†æ­¥ç»ƒï¼›å»ºè®®æ„å»ºçŸ¥è¯†ç½‘ç»œã€‚", normal: "å·©å›ºé—ä¼ ä¸è°ƒèŠ‚ã€ç”Ÿæ€ï¼›åŠ å¼ºé•¿ç©ºä¸å®éªŒè®¾è®¡é¢˜ã€‚", strong: "å¯çªç ´å¼€æ”¾æ€§é¢˜ä¸é•¿ç©ºï¼›æ³¨æ„æœ¯è¯­å‡†ç¡®ä¸é€»è¾‘é“¾å®Œæ•´ã€‚" },
            æ”¿æ²»: { weak: "å›å½’æ•™æä¸»å¹²ä¸æœ¯è¯­ï¼Œææ–™é¢˜å­¦ä¼šæŠ“å…³é”®è¯ä¸å¤šè§’åº¦ï¼›å»ºè®®å»ºç«‹æ—¶æ”¿ä¸æœ¯è¯­æœ¬ã€‚", normal: "å·©å›ºæ¨¡å—è”ç³»ä¸çƒ­ç‚¹ï¼›å¼ºåŒ–ææ–™é¢˜å®¡é¢˜ä¸ä¹¦å†™è§„èŒƒã€‚", strong: "å¯ç»“åˆæ—¶æ”¿æ‹“å±•æ·±åº¦ï¼›æ³¨æ„é€»è¾‘å±‚æ¬¡ä¸å·é¢ã€‚" },
            å†å²: { weak: "å¤¯å®æ—¶ç©ºä¸é˜¶æ®µç‰¹å¾ï¼Œææ–™é¢˜ç»ƒå®¡é¢˜ä¸å²è®ºç»“åˆï¼›å»ºè®®æ¢³ç†é€šå²ä¸ä¸“é¢˜ã€‚", normal: "å·©å›ºå²æ–™è§£è¯»ä¸å°è®ºæ–‡ï¼›åŠ å¼ºé€‰æ‹©é¢˜æ˜“é”™ç‚¹å½’çº³ã€‚", strong: "å¯æ·±åŒ–å²æ–™é¢˜ä¸å°è®ºæ–‡ï¼›æ³¨æ„è¡¨è¿°ä¸¥è°¨ä¸æ—¶é—´åˆ†é…ã€‚" },
            åœ°ç†: { weak: "å¼ºåŒ–è¯»å›¾ä¸åŒºåŸŸè®¤çŸ¥ï¼Œè‡ªç„¶ä¸äººæ–‡åŸç†å›å½’æ•™æï¼›å»ºè®®å»ºç«‹åŒºåŸŸä¸æ¨¡æ¿ã€‚", normal: "å·©å›ºç»¼åˆé¢˜ä¸å›¾è¡¨é¢˜ï¼›åŠ å¼ºå› æœé“¾ä¸æœ¯è¯­è¡¨è¿°ã€‚", strong: "å¯çªç ´ç»¼åˆé¢˜ä¸å¼€æ”¾é¢˜ï¼›æ³¨æ„å›¾è¡¨ä¿¡æ¯æå–å®Œæ•´ã€‚" },
        };
        const generateDetailedAnalysis = (student, cutoffs, allStudents) => {
            if (!student || student.scores.every(s => s.total === 0)) return { progress: "æ•°æ®ä¸è¶³", subjectAnalysis: "æ•°æ®ä¸è¶³", subjectAdviceList: [], advice: ["è¯·è¡¥å……å®Œæ•´æ•°æ®"] };
            const validScores = student.scores.filter(s => s.total > 0);
            const latest = validScores[validScores.length - 1];
            const examIdx = latest.examId;
            const currentCutoff = cutoffs[examIdx];

            let gapAnalysis = "";
            let gapSpecial = latest.total - currentCutoff.special;
            let gapBachelor = latest.total - currentCutoff.bachelor;
            if (gapSpecial >= 0) gapAnalysis = `è¶…ç‰¹æ§çº¿ ${gapSpecial.toFixed(1)} åˆ†`;
            else if (gapBachelor >= 0) gapAnalysis = `è¶…æœ¬ç§‘çº¿ ${gapBachelor.toFixed(1)} åˆ†ï¼Œè·ç‰¹æ§çº¿å·® ${Math.abs(gapSpecial).toFixed(1)} åˆ†`;
            else gapAnalysis = `è·æœ¬ç§‘çº¿å·® ${Math.abs(gapBachelor).toFixed(1)} åˆ†`;

            let progressText = `æœ€æ–°æ€»åˆ† ${latest.total} (${gapAnalysis})ã€‚`;
            const classScores = allStudents.map(s => s.scores[examIdx]?.total || 0).filter(t => t > 0);
            const classAvgTotal = classScores.length ? classScores.reduce((a,b)=>a+b,0)/classScores.length : 0;
            progressText += latest.total > classAvgTotal ? ` é«˜äºç­å‡ ${(latest.total - classAvgTotal).toFixed(1)} åˆ†ã€‚` : ` ä½äºç­å‡ ${(classAvgTotal - latest.total).toFixed(1)} åˆ†ã€‚`;

            // å½’å› åˆ†æï¼šæŒ‰ç§‘ç›®è®¡ç®—ç­å‡ã€æ ‡å‡†å·®ï¼Œæ‰¾å‡ºè–„å¼±/ä¼˜åŠ¿ç§‘ç›®
            const weakList = [];
            const strongList = [];
            const subjectStats = [];
            SUBJECTS.forEach(sub => {
                const myScore = latest.subjects[sub];
                if (myScore === undefined || myScore <= 0) return;
                const classScoresSub = allStudents.map(s => s.scores[examIdx]?.subjects[sub]).filter(v => v !== undefined && v > 0);
                if (classScoresSub.length === 0) return;
                const mean = classScoresSub.reduce((a, b) => a + b, 0) / classScoresSub.length;
                const variance = classScoresSub.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / classScoresSub.length;
                const std = Math.sqrt(variance) || 1;
                const diff = myScore - mean;
                subjectStats.push({ sub, myScore, mean, std, diff });
                if (diff <= -0.3 * std) weakList.push({ sub, diff, mean, std });
                else if (diff >= 0.3 * std) strongList.push({ sub, diff, mean, std });
            });
            let attributionText = "";
            if (weakList.length > 0) {
                const weakNames = weakList.map(w => `ã€${w.sub}ã€‘`).join("ã€");
                const weakDetail = weakList.map(w => `${w.sub}ä½äºç­å‡${(Math.abs(w.diff)).toFixed(1)}åˆ†`).join("ï¼Œ");
                attributionText = `ä¸ç­çº§å‡åˆ†ã€æ ‡å‡†å·®å¯¹æ¯”ï¼Œ${weakNames}ä¸ºå½“å‰è–„å¼±ç§‘ç›®ï¼ˆ${weakDetail}ï¼‰ã€‚`;
            } else attributionText = "ä¸ç­çº§å‡åˆ†ã€æ ‡å‡†å·®å¯¹æ¯”ï¼Œæš‚æ— æ˜æ˜¾è–„å¼±ç§‘ç›®ã€‚";
            if (strongList.length > 0) {
                const strongNames = strongList.map(s => `ã€${s.sub}ã€‘`).join("ã€");
                attributionText += `${strongNames}è¡¨ç°ä¼˜äºç­å‡ï¼Œå¯ä¿æŒå¹¶äº‰å–ç¨³å®šå‘æŒ¥ã€‚`;
            }

            // ç§‘ç›®å»ºè®®ï¼šæŒ‰è–„å¼±/ä¸€èˆ¬/ä¼˜åŠ¿å–å¯¹åº”å»ºè®®
            const subjectAdviceList = [];
            SUBJECTS.forEach(sub => {
                const myScore = latest.subjects[sub];
                if (myScore === undefined || myScore <= 0) return;
                const tip = SUBJECT_ADVICE_MAP[sub];
                if (!tip) return;
                const classScoresSub = allStudents.map(s => s.scores[examIdx]?.subjects[sub]).filter(v => v !== undefined && v > 0);
                const mean = classScoresSub.length ? classScoresSub.reduce((a,b)=>a+b,0)/classScoresSub.length : 0;
                const variance = classScoresSub.length ? classScoresSub.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / classScoresSub.length : 0;
                const std = Math.sqrt(variance) || 1;
                const diff = myScore - mean;
                let level, levelLabel;
                if (diff <= -0.3 * std) { level = "weak"; levelLabel = "è–„å¼±"; }
                else if (diff >= 0.3 * std) { level = "strong"; levelLabel = "ä¼˜åŠ¿"; }
                else { level = "normal"; levelLabel = "ä¸€èˆ¬"; }
                subjectAdviceList.push({ subject: sub, level: levelLabel, suggestion: tip[level] });
            });

            let advice = ["ä¿æŒè€ƒæ„Ÿï¼šä¸¥æ ¼æŒ‰ç…§é«˜è€ƒæ—¶é—´è¿›è¡Œå…¨çœŸæ¨¡æ‹Ÿè®­ç»ƒã€‚"];
            if (latest.total < currentCutoff.bachelor) advice.unshift("åŸºç¡€ä¸ºç‹ï¼šå»ºè®®å›å½’æ•™æï¼Œå¼ºåŒ–åŸºæœ¬æ¦‚å¿µå’Œå…¬å¼çš„è®°å¿†ã€‚");
            else advice.unshift("é‡ç‚¹çªç ´ï¼šåˆ†æä¸­æ¡£é¢˜å¤±åˆ†åŸå› ï¼Œäº‰å–çªç ´æ›´é«˜åˆ†æ•°çº¿ã€‚");

            return { progress: progressText, subjectAnalysis: attributionText, subjectAdviceList, advice };
        };

        // --- Subject Analysis Component ---
        const SubjectAnalysis = ({ allStudents, cutoffs }) => {
            const [selectedSub, setSelectedSub] = useState('è¯­æ–‡');
            const [selectedExamId, setSelectedExamId] = useState(5);
            
            const analysisData = useMemo(() => {
                const students = allStudents.filter(s => s.scores[selectedExamId]?.subjects[selectedSub] > 0);
                if (students.length === 0) return null;
                
                const scores = students.map(s => s.scores[selectedExamId].subjects[selectedSub]);
                const max = Math.max(...scores);
                const avg = (scores.reduce((a,b)=>a+b,0)/scores.length).toFixed(1);
                
                // Get cutoff for this subject (use default if not custom set)
                const subLine = cutoffs[selectedExamId].subjects ? cutoffs[selectedExamId].subjects[selectedSub] : EXAM_CONFIG[selectedExamId].defaultSubs[selectedSub];
                
                const passCount = scores.filter(s => s >= subLine).length;
                const passRate = ((passCount / scores.length) * 100).toFixed(1);
                
                // Distribution
                const fullMark = (['è¯­æ–‡','æ•°å­¦','è‹±è¯­'].includes(selectedSub)) ? 150 : 100;
                const dist = [0,0,0,0,0]; // <60%, 60-70%, 70-80%, 80-90%, >90%
                scores.forEach(s => {
                    const ratio = s / fullMark;
                    if (ratio < 0.6) dist[0]++;
                    else if (ratio < 0.7) dist[1]++;
                    else if (ratio < 0.8) dist[2]++;
                    else if (ratio < 0.9) dist[3]++;
                    else dist[4]++;
                });
                
                // Progress Stars (Compare with prev exam if possible)
                let stars = [];
                if (selectedExamId > 0) {
                    const prevId = selectedExamId - 1;
                    const diffs = students.map(s => {
                        const curr = s.scores[selectedExamId].subjects[selectedSub] || 0;
                        const prev = s.scores[prevId].subjects[selectedSub] || 0;
                        return { name: s.name, diff: curr - prev, curr: curr };
                    }).filter(d => d.curr > 0 && d.diff > 0);
                    stars = diffs.sort((a,b) => b.diff - a.diff).slice(0, 5);
                }

                // å•ç§‘å‰ååå•ï¼šæŒ‰è¯¥ç§‘åˆ†æ•°é™åºå–å‰10
                const top10 = students
                    .map(s => ({ name: s.name, id: s.id, score: s.scores[selectedExamId].subjects[selectedSub] }))
                    .filter(d => d.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 10);

                return { max, avg, passRate, dist, stars, subLine, top10 };
            }, [allStudents, selectedSub, selectedExamId, cutoffs]);

            if (!analysisData) return <div className="p-10 text-center text-gray-500">æš‚æ— è¯¥æ¬¡è€ƒè¯•çš„{selectedSub}æ•°æ®</div>;

            return (
                <div className="space-y-6 animate-fade-in no-print">
                    <div className="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl card-shadow">
                        <div className="flex gap-2 overflow-x-auto w-full md:w-auto">
                            {SUBJECTS.map(sub => (
                                <button key={sub} onClick={() => setSelectedSub(sub)} 
                                    className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition ${selectedSub === sub ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}>
                                    {sub}
                                </button>
                            ))}
                        </div>
                        <div className="flex gap-2">
                             {EXAM_CONFIG.slice().reverse().map((exam, i) => { 
                                const realIdx = EXAM_CONFIG.length - 1 - i; 
                                return <button key={realIdx} onClick={() => setSelectedExamId(realIdx)} className={`px-3 py-1 rounded text-xs ${selectedExamId === realIdx ? 'bg-blue-100 text-blue-700 border border-blue-300' : 'bg-white border text-gray-500'}`}>{exam.name.split(' ')[1]}</button>; 
                            })}
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-white p-4 rounded-xl card-shadow text-center border-l-4 border-green-500">
                            <p className="text-gray-500 text-sm">æœ€é«˜åˆ†</p>
                            <p className="text-3xl font-bold text-gray-800">{analysisData.max}</p>
                        </div>
                        <div className="bg-white p-4 rounded-xl card-shadow text-center border-l-4 border-blue-500">
                            <p className="text-gray-500 text-sm">å¹³å‡åˆ†</p>
                            <p className="text-3xl font-bold text-gray-800">{analysisData.avg}</p>
                        </div>
                        <div className="bg-white p-4 rounded-xl card-shadow text-center border-l-4 border-purple-500">
                            <p className="text-gray-500 text-sm">åŠæ ¼ç‡ (â‰¥{analysisData.subLine})</p>
                            <p className="text-3xl font-bold text-gray-800">{analysisData.passRate}%</p>
                        </div>
                        <div className="bg-white p-4 rounded-xl card-shadow text-center border-l-4 border-orange-500">
                            <p className="text-gray-500 text-sm">ä¼˜ç§€äººæ•° (â‰¥80%)</p>
                            <p className="text-3xl font-bold text-gray-800">{analysisData.dist[3] + analysisData.dist[4]}äºº</p>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-6 rounded-xl card-shadow">
                            <h3 className="font-bold text-gray-800 mb-4 flex items-center"><Icons.Trophy className="mr-2 text-amber-500"/> {selectedSub} å•ç§‘å‰ååå•</h3>
                            {analysisData.top10.length > 0 ? (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b-2 border-gray-200 text-gray-600">
                                                <th className="text-left py-2 px-3">æ’å</th>
                                                <th className="text-left py-2 px-3">å§“å</th>
                                                <th className="text-right py-2 px-3">{selectedSub}åˆ†æ•°</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {analysisData.top10.map((row, i) => (
                                                <tr key={row.id} className="border-b border-gray-100 hover:bg-amber-50/50">
                                                    <td className="py-2.5 px-3 font-mono font-bold">{i + 1}</td>
                                                    <td className="py-2.5 px-3 font-medium text-gray-800">{row.name}</td>
                                                    <td className="py-2.5 px-3 text-right font-bold text-amber-600">{row.score}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            ) : (
                                <p className="text-gray-400 text-sm">æš‚æ— è¯¥ç§‘æœ‰æ•ˆæˆç»©</p>
                            )}
                        </div>
                        <div className="bg-white p-6 rounded-xl card-shadow">
                            <h3 className="font-bold text-gray-800 mb-4 flex items-center"><Icons.TrendingUp className="mr-2 text-red-500"/> è¿›æ­¥ä¹‹æ˜Ÿ (è¾ƒä¸Šæ¬¡)</h3>
                            {analysisData.stars.length > 0 ? (
                                <ul className="space-y-3">
                                    {analysisData.stars.map((s, i) => (
                                        <li key={i} className="flex justify-between items-center border-b pb-2 last:border-0">
                                            <span className="font-bold text-gray-700">{s.name}</span>
                                            <span className="text-sm bg-red-100 text-red-600 px-2 py-1 rounded-full font-bold">+{s.diff}åˆ†</span>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <p className="text-gray-400 text-sm">æš‚æ— å¯¹æ¯”æ•°æ®</p>
                            )}
                        </div>
                    </div>

                    <div className="bg-white p-6 rounded-xl card-shadow">
                        <h3 className="font-bold text-gray-800 mb-4">ğŸ“Š {selectedSub}æˆç»©åˆ†å¸ƒç›´æ–¹å›¾</h3>
                        <div className="h-64">
                            <ResponsiveContainer width="100%" height="100%">
                                <BarChart data={[
                                    {range: '<60%', count: analysisData.dist[0]},
                                    {range: '60-70%', count: analysisData.dist[1]},
                                    {range: '70-80%', count: analysisData.dist[2]},
                                    {range: '80-90%', count: analysisData.dist[3]},
                                    {range: '>90%', count: analysisData.dist[4]},
                                ]}>
                                    <CartesianGrid strokeDasharray="3 3" vertical={false}/>
                                    <XAxis dataKey="range" fontSize={12}/>
                                    <YAxis allowDecimals={false}/>
                                    <Tooltip cursor={{fill: '#f3f4f6'}}/>
                                    <Bar dataKey="count" fill="#3b82f6" radius={[4, 4, 0, 0]} barSize={40}>
                                        <LabelList dataKey="count" position="top" />
                                    </Bar>
                                </BarChart>
                            </ResponsiveContainer>
                        </div>
                    </div>
                    
                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-200">
                        <h3 className="font-bold text-blue-800 mb-2">ğŸ¤– AI å­¦æƒ…ç®€æŠ¥</h3>
                        <p className="text-sm text-blue-800 leading-relaxed">
                            æœ¬æ¬¡{EXAM_CONFIG[selectedExamId].name}ä¸­ï¼Œå…¨ç­{selectedSub}å­¦ç§‘å¹³å‡åˆ†ä¸º <span className="font-bold">{analysisData.avg}</span>ã€‚
                            ä»åˆ†å¸ƒæ¥çœ‹ï¼Œä¼˜ç§€ç‡ï¼ˆå¾—åˆ†ç‡â‰¥80%ï¼‰è¾¾åˆ°äº† <span className="font-bold">{(( (analysisData.dist[3] + analysisData.dist[4]) / allStudents.length ) * 100).toFixed(1)}%</span>ï¼Œ
                            å°šæœ‰ <span className="font-bold">{analysisData.dist[0]}</span> äººæœªåŠæ ¼ã€‚
                            {analysisData.dist[0] > 5 ? "å»ºè®®é‡ç‚¹å…³æ³¨åè¿›ç”Ÿçš„åŸºç¡€å·©å›ºã€‚" : "æ•´ä½“åŸºç¡€è¾ƒä¸ºæ‰å®ï¼Œå¯é€‚å½“å¢åŠ æ‹”é«˜è®­ç»ƒã€‚"}
                        </p>
                    </div>
                </div>
            );
        };

        // --- Dashboard Components ---
        const Dashboard = ({ allStudents, cutoffs, onStudentClick }) => {
            const stats = useMemo(() => {
                return EXAM_CONFIG.map((cfg, idx) => {
                    const students = allStudents.filter(s => s.scores[idx] && s.scores[idx].total > 0);
                    if (students.length === 0) return { name: cfg.name, avg: 0, specialCount: 0, bachelorCount: 0, subs: {} };
                    const totalSum = students.reduce((a, b) => a + b.scores[idx].total, 0);
                    const specialList = students.filter(s => s.scores[idx].total >= cutoffs[idx].special);
                    const bachelorList = students.filter(s => s.scores[idx].total >= cutoffs[idx].bachelor);
                    let subSums = {}; let subCounts = {};
                    students.forEach(s => { Object.entries(s.scores[idx].subjects).forEach(([sub, score]) => { if(score > 0) { subSums[sub] = (subSums[sub] || 0) + score; subCounts[sub] = (subCounts[sub] || 0) + 1; } }); });
                    let subAvgs = {}; SUBJECTS.forEach(sub => { subAvgs[sub] = subCounts[sub] ? parseFloat((subSums[sub] / subCounts[sub]).toFixed(1)) : 0; });
                    return { name: cfg.name.split(' ')[1], avg: parseFloat((totalSum / students.length).toFixed(1)), specialCount: specialList.length, bachelorCount: bachelorList.length, specialList: specialList.sort((a,b) => b.scores[idx].total - a.scores[idx].total), ...subAvgs };
                });
            }, [allStudents, cutoffs]);
            const latestStat = stats[stats.length - 1];
            const bachelorList = allStudents.filter(s => s.scores[5].total >= cutoffs[5].bachelor).sort((a,b) => b.scores[5].total - a.scores[5].total);
            const progressOver30 = allStudents
                .filter(s => s.scores[5]?.total > 0 && s.scores[4]?.total > 0)
                .map(s => ({ ...s, progress: s.scores[5].total - s.scores[4].total }))
                .filter(s => s.progress > 30)
                .sort((a, b) => b.progress - a.progress);

            return (
                <div className="space-y-6 animate-fade-in no-print">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-4 rounded-xl card-shadow"><h3 className="font-bold text-gray-800 mb-4 flex items-center"><Icons.TrendingUp className="mr-2 text-blue-600"/> ç­çº§æ€»å¹³å‡åˆ†èµ°åŠ¿</h3><div className="h-64"><ResponsiveContainer width="100%" height="100%"><LineChart data={stats}><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey="name" fontSize={12}/><YAxis domain={['auto', 'auto']}/><Tooltip/><Legend/><Line type="monotone" dataKey="avg" name="æ€»å¹³å‡åˆ†" stroke="#2563eb" strokeWidth={3} dot={{r:4}}/></LineChart></ResponsiveContainer></div></div>
                        <div className="bg-white p-4 rounded-xl card-shadow"><h3 className="font-bold text-gray-800 mb-4 flex items-center"><Icons.Trophy className="mr-2 text-purple-600"/> ä¸Šçº¿äººæ•°èµ°åŠ¿</h3><div className="h-64"><ResponsiveContainer width="100%" height="100%"><LineChart data={stats}><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey="name" fontSize={12}/><YAxis allowDecimals={false}/><Tooltip/><Legend/><Line type="monotone" dataKey="specialCount" name="ç‰¹æ§çº¿äººæ•°" stroke="#7e22ce" strokeWidth={3}/><Line type="monotone" dataKey="bachelorCount" name="æœ¬ç§‘çº¿äººæ•°" stroke="#2563eb" strokeWidth={3}/></LineChart></ResponsiveContainer></div></div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white p-4 rounded-xl card-shadow"><h3 className="font-bold text-gray-800 mb-4 flex items-center"><Icons.Activity className="mr-2 text-green-600"/> å„ç§‘å¹³å‡åˆ†èµ°åŠ¿</h3><div className="h-72"><ResponsiveContainer width="100%" height="100%"><LineChart data={stats}><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey="name" fontSize={12}/><YAxis domain={[0, 150]}/><Tooltip/><Legend wrapperStyle={{fontSize:'10px'}}/>{SUBJECTS.map((sub, i) => <Line key={sub} type="monotone" dataKey={sub} stroke={COLORS[i]} strokeWidth={2} dot={false}/>)}</LineChart></ResponsiveContainer></div></div>
                        <div className="bg-white p-6 rounded-xl card-shadow flex flex-col"><div className="flex justify-between items-center mb-4 border-b pb-2"><h3 className="font-bold text-lg text-gray-800">ğŸ† æœ€æ–°å…‰è£æ¦œ</h3><span className="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded">ç‰¹æ§: {cutoffs[5].special} | æœ¬ç§‘: {cutoffs[5].bachelor}</span></div><div className="flex-1 overflow-y-auto"><div className="mb-4"><h4 className="font-bold text-purple-700 mb-2 flex items-center"><span className="w-2 h-2 rounded-full bg-purple-700 mr-2"></span>ç‰¹æ§çº¿ ({latestStat.specialList?.length || 0}äºº)</h4><div className="flex flex-wrap gap-2">{latestStat.specialList && latestStat.specialList.map((s, i) => <button key={i} onClick={() => onStudentClick(s)} className="px-3 py-2 bg-purple-50 text-purple-700 text-base font-bold rounded hover:bg-purple-100 transition">{s.name} <span>{s.scores[5].total}</span></button>)}</div></div><div><h4 className="font-bold text-blue-600 mb-2 flex items-center"><span className="w-2 h-2 rounded-full bg-blue-600 mr-2"></span>æœ¬ç§‘çº¿ ({bachelorList.length}äºº)</h4><div className="flex flex-wrap gap-2">{bachelorList.map((s, i) => <button key={i} onClick={() => onStudentClick(s)} className="px-3 py-2 bg-blue-50 text-blue-600 text-base font-bold rounded hover:bg-blue-100 transition">{s.name} <span>{s.scores[5].total}</span></button>)}</div></div><div className="mt-4"><h4 className="font-bold text-green-600 mb-2 flex items-center"><span className="w-2 h-2 rounded-full bg-green-600 mr-2"></span>åˆ†æ•°è¿›æ­¥è¶…è¿‡30åˆ† ({progressOver30.length}äºº)</h4><div className="flex flex-wrap gap-2">{progressOver30.map((s, i) => <button key={i} onClick={() => onStudentClick(s)} className="px-3 py-2 bg-green-50 text-green-700 text-base font-bold rounded hover:bg-green-100 transition">{s.name}ï¼ˆ{s.progress}åˆ†ï¼‰</button>)}</div></div></div></div>
                    </div>
                </div>
            );
        };

        // --- Leaderboard ---
        const Leaderboard = ({ allStudents, cutoffs, onStudentClick }) => {
            const [selectedExamId, setSelectedExamId] = useState(5);
            const [searchTerm, setSearchTerm] = useState("");
            const sortedStudents = useMemo(() => {
                let list = allStudents.filter(s => s.scores[selectedExamId]?.total > 0);
                if (searchTerm) list = list.filter(s => s.name.includes(searchTerm) || s.id.includes(searchTerm));
                return list.sort((a, b) => b.scores[selectedExamId].total - a.scores[selectedExamId].total);
            }, [allStudents, selectedExamId, searchTerm]);
            const currentCutoff = cutoffs[selectedExamId];

            return (
                <div className="bg-white rounded-xl card-shadow overflow-hidden no-print">
                    <div className="p-6 border-b flex flex-col md:flex-row justify-between items-center gap-4 bg-gray-50">
                        <div className="flex items-center gap-4">
                            <h2 className="text-xl font-bold text-gray-800 flex items-center"><Icons.FileText className="mr-2"/> æˆç»©æ€»è¡¨</h2>
                            <div className="relative">
                                <Icons.Search className="absolute left-3 top-2.5 text-gray-400 w-4 h-4"/>
                                <input type="text" placeholder="æœç´¢å§“å..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="pl-9 pr-4 py-2 border rounded-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-48"/>
                            </div>
                        </div>
                        
                        {/* Minimalist Cutoff Display */}
                        <div className="flex items-center gap-3 text-sm bg-white px-4 py-2 rounded-full border shadow-sm font-mono whitespace-nowrap">
                            <span className="text-purple-700 font-extrabold">ç‰¹æ§ {currentCutoff.special}</span>
                            <span className="text-gray-300">|</span>
                            <span className="text-blue-600 font-extrabold">æœ¬ç§‘ {currentCutoff.bachelor}</span>
                        </div>

                        <div className="flex gap-2 overflow-x-auto pb-2 md:pb-0">
                            {EXAM_CONFIG.slice().reverse().map((exam, i) => { 
                                const realIdx = EXAM_CONFIG.length - 1 - i; 
                                return <button key={realIdx} onClick={() => setSelectedExamId(realIdx)} className={`px-4 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition ${selectedExamId === realIdx ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-gray-600 border hover:bg-gray-100'}`}>{exam.name.split(' ')[1]}</button>; 
                            })}
                        </div>
                    </div>
                    
                    {/* Sticky Table Header Fixed */}
                    <div className="overflow-x-auto max-h-[70vh]">
                        <table className="w-full text-sm text-left border-collapse sticky-header">
                            <thead className="bg-gray-100 text-gray-700 font-bold border-b-2 border-gray-200 sticky-header">
                                <tr>
                                    <th className="px-6 py-4 sticky-col sticky left-0 bg-gray-100 z-20">ç­æ’</th>
                                    <th className="px-6 py-4 z-10 bg-gray-100">å¹´çº§æ’å</th>
                                    <th className="px-6 py-4 sticky-col sticky left-16 bg-gray-100 z-20">å§“å</th>
                                    <th className="px-6 py-4 text-right bg-blue-50/50 text-blue-800 z-10">æ€»åˆ†</th>
                                    {SUBJECTS.map(s => <th key={s} className="px-4 py-4 text-right text-gray-500 font-medium z-10 bg-gray-100">{s}</th>)}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {sortedStudents.map((s, idx) => { 
                                    const sc = s.scores[selectedExamId]; 
                                    const isSpecial = sc.total >= currentCutoff.special; 
                                    const isBachelor = !isSpecial && sc.total >= currentCutoff.bachelor; 
                                    let textClass = "text-gray-900"; 
                                    if (isSpecial) textClass = "text-purple-700 font-bold"; 
                                    else if (isBachelor) textClass = "text-blue-600 font-bold"; 
                                    
                                    return (
                                        <tr key={s.id} onClick={() => onStudentClick(s)} className="hover:bg-blue-50 cursor-pointer transition-colors group">
                                            <td className={`px-6 py-3 font-mono sticky left-0 bg-white group-hover:bg-blue-50 z-10 ${textClass}`}>{idx + 1}</td>
                                            <td className={`px-6 py-3 font-mono ${textClass} opacity-80`}>{sc.gradeRank || '-'}</td>
                                            <td className={`px-6 py-3 sticky left-16 bg-white group-hover:bg-blue-50 z-10 ${textClass}`}>{s.name}</td>
                                            <td className={`px-6 py-3 text-right bg-blue-50/30 group-hover:bg-blue-50 ${textClass}`}>{sc.total}</td>
                                            {SUBJECTS.map(sub => <td key={sub} className={`px-4 py-3 text-right font-mono ${textClass} opacity-90`}>{sc.subjects[sub] || '-'}</td>)}
                                        </tr>
                                    ); 
                                })}
                                {sortedStudents.length === 0 && <tr><td colSpan={12} className="px-6 py-12 text-center text-gray-400">æš‚æ— è¯¥æ¬¡è€ƒè¯•æ•°æ®</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // --- Print Components (Optimized for 2 Pages & Bold) ---
        // PAGE 1
        const ReportPage = ({ student, cutoffs, allStudents }) => {
            const analysis = useMemo(() => generateDetailedAnalysis(student, cutoffs, allStudents), [student, cutoffs, allStudents]);
            const chartData = student.scores.map((s, i) => ({ name: EXAM_CONFIG[i].name.replace(/[â‘ -â‘¥]/g, '').replace('è”è€ƒ',''), total: s.total }));
            const chartYDomain = useMemo(() => {
                const vals = chartData.map(d => d.total).filter(v => v != null && v > 0);
                if (vals.length === 0) return ['auto', 'auto'];
                const mn = Math.min(...vals), mx = Math.max(...vals);
                const pad = Math.max(15, (mx - mn) * 0.12);
                return [mn - pad, mx + pad];
            }, [chartData]);
            return (
                <div className="print-page print-page-1">
                    <div className="border-b-2 border-black pb-2 mb-2 text-center"><h1 className="text-2xl font-extrabold tracking-widest text-black">2026å±Šé«˜33ç­å­¦ç”Ÿå­¦æƒ…åˆ†ææŠ¥å‘Š</h1><p className="text-xs mt-1 text-gray-700 font-bold">ç”Ÿæˆæ—¥æœŸï¼š{new Date().toLocaleDateString()} &nbsp;|&nbsp; ç­çº§ï¼šé«˜33ç­</p></div>
                    <div className="mb-2 border border-black p-2 rounded-sm bg-gray-50"><h3 className="font-extrabold border-l-4 border-black pl-2 mb-1 text-base">ä¸€ã€å­¦ç”ŸåŸºæœ¬ä¿¡æ¯</h3><div className="flex justify-between items-end px-2"><div><span className="text-gray-600 text-xs font-bold">å§“å</span><p className="text-lg font-extrabold">{student.name}</p></div><div><span className="text-gray-600 text-xs font-bold">å­¦å·</span><p className="text-base font-bold font-mono">{student.id}</p></div><div><span className="text-gray-600 text-xs font-bold">æœ€æ–°æ€»åˆ†</span><p className="text-lg font-extrabold text-blue-800">{student.scores[5]?.total || '-'}</p></div><div><span className="text-gray-600 text-xs font-bold">ç­æ’</span><p className="text-lg font-extrabold">{student.scores[5]?.rank || '-'}</p></div><div><span className="text-gray-600 text-xs font-bold">å¹´çº§æ’å</span><p className="text-lg font-extrabold">{student.scores[5]?.gradeRank || '-'}</p></div></div></div>
                    <div className="mb-2"><h3 className="font-extrabold border-l-4 border-black pl-2 mb-1 text-base">äºŒã€å…­æ¬¡è”è€ƒæˆç»©å…¨æ™¯è¡¨</h3><table className="w-full text-xs text-center border-collapse border border-black"><thead className="bg-gray-200 font-extrabold text-black"><tr><th className="border border-black p-1">è€ƒè¯•åç§°</th><th className="border border-black p-1 bg-blue-100">æ€»åˆ†</th><th className="border border-black p-1">ç­æ’</th><th className="border border-black p-1">æ ¡æ’</th><th className="border border-black p-1 text-purple-900">ç‰¹æ§çº¿</th><th className="border border-black p-1 text-blue-900">æœ¬ç§‘çº¿</th>{SUBJECTS.map(s => <th key={s} className="border border-black p-1">{s}</th>)}</tr></thead><tbody>{student.scores.map((s, idx) => <tr key={idx} className="font-bold"><td className="border border-black p-1">{EXAM_CONFIG[idx].name}</td><td className="border border-black p-1 bg-blue-50 font-extrabold">{s.total || '-'}</td><td className="border border-black p-1">{s.rank || '-'}</td><td className="border border-black p-1">{s.gradeRank || '-'}</td><td className="border border-black p-1 text-purple-900">{cutoffs[idx].special}</td><td className="border border-black p-1 text-blue-900">{cutoffs[idx].bachelor}</td>{SUBJECTS.map(sub => <td key={sub} className="border border-black p-1">{s.subjects[sub] || '-'}</td>)}</tr>)}</tbody></table></div>
                    {/* Chart (FIXED PIXEL SIZE FOR PRINT SAFETY) */}
                    <div className="mb-2 border border-gray-400 p-2"><h4 className="text-center font-extrabold text-sm mb-1">ä¸‰ã€æ€»åˆ†èµ°åŠ¿å›¾</h4><div style={{height: "180px", overflow: "hidden"}}><ResponsiveContainer width="100%" height="100%"><LineChart data={chartData} margin={{ top: 32, right: 28, bottom: 20, left: 28 }}><CartesianGrid strokeDasharray="3 3"/><XAxis dataKey="name" fontSize={10} interval={0} tick={{fontWeight:'bold'}} padding={{ left: 24, right: 24 }} /><YAxis domain={chartYDomain} fontSize={10} tick={{fontWeight:'bold'}} width={28}/><Line type="monotone" dataKey="total" stroke="#000" strokeWidth={2} dot={{r:3}} isAnimationActive={false}><LabelList dataKey="total" position="top" style={{fontSize:'10px', fontWeight:'bold'}}/></Line></LineChart></ResponsiveContainer></div></div>
                    <div className="flex-1 border border-black p-3 rounded-sm"><h3 className="font-extrabold border-l-4 border-black pl-2 mb-1 text-base">å››ã€æ™ºèƒ½è¯Šæ–­ä¸å¤‡è€ƒå»ºè®®</h3><div className="text-xs leading-relaxed space-y-2 text-justify font-bold text-gray-900"><p><strong>ã€å­¦æƒ…ç»¼è¿°ã€‘ï¼š</strong>{analysis.progress}</p><p><strong>ã€å½’å› åˆ†æã€‘ï¼š</strong>{analysis.subjectAnalysis}</p>{analysis.subjectAdviceList && analysis.subjectAdviceList.length > 0 && <div className="mt-2"><strong>ã€ç§‘ç›®å»ºè®®ã€‘ï¼š</strong><ul className="list-none pl-0 mt-1 space-y-1">{analysis.subjectAdviceList.map((item, i) => <li key={i}><span className="font-extrabold">{item.subject}</span>ï¼ˆ{item.level}ï¼‰ï¼š{item.suggestion}</li>)}</ul></div>}<div className="mt-2"><strong>ã€è¡ŒåŠ¨æŒ‡å—ã€‘ï¼š</strong><ul className="list-decimal pl-5 mt-1 space-y-1">{analysis.advice.map((a, i) => <li key={i}>{a}</li>)}</ul></div></div></div>
                </div>
            );
        };

        // PAGE 2 (ä»…æ‰“å°æ—¶ä½¿ç”¨)
        const ReportPageTwo = ({ student }) => (
            <div className="print-page">
                <div className="border-b-2 border-black pb-2 mb-4 text-center"><h1 className="text-lg font-extrabold text-black">è‡ªæˆ‘åæ€ä¸å®¶æ ¡å…±è‚² (ç¬¬äºŒé¡µ)</h1><p className="text-xs mt-1 font-bold">å§“åï¼š{student.name}</p></div>
                <div className="flex-1 mb-4 border-2 border-black rounded-sm p-4 relative">
                    <h3 className="font-extrabold text-base mb-3">äº”ã€è‡ªæˆ‘åæ€ä¸è¡ŒåŠ¨å¥‘çº¦ (å­¦ç”Ÿäº²ç¬”)</h3>
                    <div className="grid grid-cols-2 gap-8 mb-4"><div><p className="font-bold text-xs mb-1">æœ¬æ¬¡è€ƒè¯•æ ¸å¿ƒå¾—å¤±ï¼š</p><div className="h-16 border-b-2 border-gray-400"></div></div><div><p className="font-bold text-xs mb-1">ä¸‹é˜¶æ®µç›®æ ‡åˆ†æ•°ï¼š</p><div className="h-16 border-b-2 border-gray-400"></div></div></div>
                    <p className="font-bold text-xs mb-2">å…·ä½“çš„æ”¹è¿›æªæ–½ä¸æ¯æ—¥è®¡åˆ’ï¼š</p>
                    <div className="w-full h-[320px]" style={{backgroundImage: 'linear-gradient(#9ca3af 1px, transparent 1px)', backgroundSize: '100% 30px'}}></div>
                    <div className="mt-4 flex justify-end"><p className="text-xs font-bold">å­¦ç”Ÿç­¾åï¼š____________________</p></div>
                </div>
                <div className="h-40 border-2 border-black rounded-sm p-4 relative">
                    <h3 className="font-extrabold text-base mb-3">å…­ã€å®¶é•¿å¯„è¯­</h3>
                    <div className="w-full h-20" style={{backgroundImage: 'linear-gradient(#d1d5db 1px, transparent 1px)', backgroundSize: '100% 30px'}}></div>
                    <div className="mt-4 flex justify-end gap-8"><p className="text-xs font-bold">å®¶é•¿ç­¾åï¼š____________________</p><p className="text-xs font-bold mt-1">æ—¥æœŸï¼š______å¹´___æœˆ___æ—¥</p></div>
                </div>
            </div>
        );

        // --- å‰ç«¯å­¦æƒ…æŠ¥å‘Šï¼ˆæ¨¡å—åŒ–å¸ƒå±€ï¼Œä¸åŒ…å«äº”ã€å…­ï¼‰---
        const StudentReportScreen = ({ student, cutoffs, allStudents, onBack }) => {
            const analysis = useMemo(() => generateDetailedAnalysis(student, cutoffs, allStudents), [student, cutoffs, allStudents]);
            const chartData = student.scores.map((s, i) => ({ name: EXAM_CONFIG[i].name.replace(/[â‘ -â‘¥]/g, '').replace('è”è€ƒ',''), total: s.total }));
            const chartYDomain = useMemo(() => {
                const vals = chartData.map(d => d.total).filter(v => v != null && v > 0);
                if (vals.length === 0) return ['auto', 'auto'];
                const mn = Math.min(...vals), mx = Math.max(...vals);
                const pad = Math.max(20, (mx - mn) * 0.15);
                return [mn - pad, mx + pad];
            }, [chartData]);
            const basicItems = [
                { label: 'å§“å', value: student.name },
                { label: 'å­¦å·', value: student.id },
                { label: 'æœ€æ–°æ€»åˆ†', value: student.scores[5]?.total ?? '-', highlight: true },
                { label: 'ç­æ’', value: student.scores[5]?.rank ?? '-' },
                { label: 'å¹´çº§æ’å', value: student.scores[5]?.gradeRank ?? '-' },
            ];
            return (
                <div className="min-h-screen bg-slate-50">
                    <div className="sticky top-0 z-10 bg-white/95 backdrop-blur border-b shadow-sm">
                        <div className="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between gap-4">
                            <button onClick={onBack} className="flex items-center gap-2 text-slate-600 hover:text-blue-600 font-medium transition">
                                <Icons.ChevronLeft className="w-5 h-5"/> è¿”å›
                            </button>
                            <span className="text-sm text-slate-500">ç”Ÿæˆæ—¥æœŸï¼š{new Date().toLocaleDateString('zh-CN')} Â· é«˜33ç­</span>
                        </div>
                    </div>
                    <div className="max-w-5xl mx-auto px-4 py-8 space-y-8">
                        <header className="text-center pb-2">
                            <h1 className="text-2xl md:text-3xl font-extrabold text-slate-800 tracking-tight">2026å±Šé«˜33ç­å­¦ç”Ÿå­¦æƒ…åˆ†ææŠ¥å‘Š</h1>
                        </header>

                        <section className="bg-white rounded-2xl shadow-md border border-slate-200/80 overflow-hidden">
                            <div className="px-6 py-4 border-b bg-slate-50">
                                <h2 className="text-lg font-bold text-slate-800 flex items-center"><span className="w-1 h-6 bg-blue-500 rounded-full mr-3"/>ä¸€ã€å­¦ç”ŸåŸºæœ¬ä¿¡æ¯</h2>
                            </div>
                            <div className="p-6">
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6">
                                    {basicItems.map((item, i) => (
                                        <div key={i} className="text-center p-4 rounded-xl bg-slate-50/80">
                                            <p className="text-xs text-slate-500 font-medium mb-1">{item.label}</p>
                                            <p className={`text-lg font-bold ${item.highlight ? 'text-blue-600' : 'text-slate-800'}`}>{item.value}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </section>

                        <section className="bg-white rounded-2xl shadow-md border border-slate-200/80 overflow-hidden">
                            <div className="px-6 py-4 border-b bg-slate-50">
                                <h2 className="text-lg font-bold text-slate-800 flex items-center"><span className="w-1 h-6 bg-blue-500 rounded-full mr-3"/>äºŒã€å…­æ¬¡è”è€ƒæˆç»©å…¨æ™¯è¡¨</h2>
                            </div>
                            <div className="p-4 overflow-x-auto">
                                <table className="w-full text-sm text-center border-collapse">
                                    <thead><tr className="bg-slate-100 text-slate-700 font-bold"><th className="border border-slate-200 py-3 px-2">è€ƒè¯•åç§°</th><th className="border border-slate-200 py-3 px-2 bg-blue-50">æ€»åˆ†</th><th className="border border-slate-200 py-3 px-2">ç­æ’</th><th className="border border-slate-200 py-3 px-2">æ ¡æ’</th><th className="border border-slate-200 py-3 px-2 text-purple-700">ç‰¹æ§çº¿</th><th className="border border-slate-200 py-3 px-2 text-blue-700">æœ¬ç§‘çº¿</th>{SUBJECTS.map(s => <th key={s} className="border border-slate-200 py-3 px-2">{s}</th>)}</tr></thead>
                                    <tbody>
                                        {student.scores.map((s, idx) => <tr key={idx} className="font-medium text-slate-800"><td className="border border-slate-200 py-2 px-2">{EXAM_CONFIG[idx].name}</td><td className="border border-slate-200 py-2 px-2 bg-blue-50/50 font-bold">{s.total || '-'}</td><td className="border border-slate-200 py-2 px-2">{s.rank || '-'}</td><td className="border border-slate-200 py-2 px-2">{s.gradeRank || '-'}</td><td className="border border-slate-200 py-2 px-2 text-purple-600">{cutoffs[idx].special}</td><td className="border border-slate-200 py-2 px-2 text-blue-600">{cutoffs[idx].bachelor}</td>{SUBJECTS.map(sub => <td key={sub} className="border border-slate-200 py-2 px-2">{s.subjects[sub] ?? '-'}</td>)}</tr>)}
                                    </tbody>
                                </table>
                            </div>
                        </section>

                        <section className="bg-white rounded-2xl shadow-md border border-slate-200/80 overflow-hidden">
                            <div className="px-6 py-4 border-b bg-slate-50">
                                <h2 className="text-lg font-bold text-slate-800 flex items-center"><span className="w-1 h-6 bg-blue-500 rounded-full mr-3"/>ä¸‰ã€æ€»åˆ†èµ°åŠ¿å›¾</h2>
                            </div>
                            <div className="p-6 overflow-hidden">
                                <div className="h-72 min-h-0 w-full">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <LineChart data={chartData} margin={{ top: 40, right: 32, bottom: 24, left: 32 }}>
                                            <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0"/>
                                            <XAxis dataKey="name" fontSize={12} tick={{ fill: '#64748b' }} padding={{ left: 20, right: 20 }} />
                                            <YAxis domain={chartYDomain} fontSize={12} tick={{ fill: '#64748b' }} width={36}/>
                                            <Tooltip contentStyle={{ borderRadius: 8 }}/>
                                            <Line type="monotone" dataKey="total" stroke="#2563eb" strokeWidth={2} dot={{ r: 4 }} name="æ€»åˆ†"><LabelList dataKey="total" position="top" className="font-bold"/></Line>
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                            </div>
                        </section>

                        <section className="bg-white rounded-2xl shadow-md border border-slate-200/80 overflow-hidden">
                            <div className="px-6 py-4 border-b bg-slate-50">
                                <h2 className="text-lg font-bold text-slate-800 flex items-center"><span className="w-1 h-6 bg-blue-500 rounded-full mr-3"/>å››ã€æ™ºèƒ½è¯Šæ–­ä¸å¤‡è€ƒå»ºè®®</h2>
                            </div>
                            <div className="p-6 space-y-5 text-slate-700">
                                <div className="p-4 rounded-xl bg-blue-50/80 border border-blue-100">
                                    <p className="text-xs font-bold text-blue-700 mb-1">ã€å­¦æƒ…ç»¼è¿°ã€‘</p>
                                    <p className="text-sm leading-relaxed">{analysis.progress}</p>
                                </div>
                                <div className="p-4 rounded-xl bg-amber-50/80 border border-amber-100">
                                    <p className="text-xs font-bold text-amber-800 mb-1">ã€å½’å› åˆ†æã€‘</p>
                                    <p className="text-sm leading-relaxed">{analysis.subjectAnalysis}</p>
                                </div>
                                {analysis.subjectAdviceList && analysis.subjectAdviceList.length > 0 && (
                                    <div className="p-4 rounded-xl bg-slate-50/80 border border-slate-200">
                                        <p className="text-xs font-bold text-slate-700 mb-3">ã€ç§‘ç›®å»ºè®®ã€‘</p>
                                        <div className="space-y-3">
                                            {analysis.subjectAdviceList.map((item, i) => (
                                                <div key={i} className="pl-3 border-l-2 border-slate-300">
                                                    <p className="text-sm font-bold text-slate-800">{item.subject} <span className={`text-xs font-medium px-1.5 py-0.5 rounded ${item.level === 'è–„å¼±' ? 'bg-red-100 text-red-700' : item.level === 'ä¼˜åŠ¿' ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-600'}`}>{item.level}</span></p>
                                                    <p className="text-sm leading-relaxed mt-1 text-slate-600">{item.suggestion}</p>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                <div className="p-4 rounded-xl bg-green-50/80 border border-green-100">
                                    <p className="text-xs font-bold text-green-800 mb-2">ã€è¡ŒåŠ¨æŒ‡å—ã€‘</p>
                                    <ul className="list-decimal list-inside space-y-2 text-sm leading-relaxed">{analysis.advice.map((a, i) => <li key={i}>{a}</li>)}</ul>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const DataUploadModal = ({ isOpen, onClose, onDataUpdate, initialCutoffs }) => {
            if (!isOpen) return null;
            const [cutoffs, setCutoffs] = useState(initialCutoffs);
            const [files, setFiles] = useState(Array(6).fill(null));
            const [expandedExamId, setExpandedExamId] = useState(null);
            const handleCutoffChange = (index, field, value) => { const newCutoffs = [...cutoffs]; newCutoffs[index] = { ...newCutoffs[index], [field]: Number(value) }; setCutoffs(newCutoffs); };
            const handleSubjectLineChange = (examIndex, subject, value) => { const newCutoffs = [...cutoffs]; if (!newCutoffs[examIndex].subjects) newCutoffs[examIndex].subjects = { ...EXAM_CONFIG[examIndex].defaultSubs }; newCutoffs[examIndex].subjects[subject] = Number(value); setCutoffs(newCutoffs); };
            const handleFileChange = (index, e) => { const newFiles = [...files]; newFiles[index] = e.target.files[0]; setFiles(newFiles); };
            const parseAndMerge = (studentMap, rows, index) => { 
                rows.forEach(row => { 
                    if (!row[0] || row[0].toString().includes('å§“å') || row[0].toString().includes('å¹³å‡åˆ†')) return; 
                    const id = row[1] ? row[1].toString().trim() : ""; 
                    if(!id) return; 
                    if (!studentMap[id]) studentMap[id] = { name: row[0], id: id, scores: Array(6).fill(null).map((_, i) => ({ examId: i, total: 0, rank: 0, gradeRank: 0, subjects: {} })) }; 
                    const rankStr = row[3] ? row[3].toString() : "0/0";
                    const rankParts = rankStr.split('/');
                    const classRank = parseInt(rankParts[0]) || 0;
                    const gradeRank = parseInt(rankParts[1]) || 0;
                    studentMap[id].scores[index] = { examId: index, total: parseFloat(row[2]) || 0, rank: classRank, gradeRank: gradeRank, subjects: { 'è¯­æ–‡': parseFloat(row[4])||0, 'æ•°å­¦': parseFloat(row[6])||0, 'è‹±è¯­': parseFloat(row[8])||0, 'ç‰©ç†': parseFloat(row[10])||0, 'åŒ–å­¦': parseFloat(row[12])||0, 'ç”Ÿç‰©': parseFloat(row[14])||0, 'æ”¿æ²»': parseFloat(row[16])||0, 'å†å²': parseFloat(row[18])||0, 'åœ°ç†': parseFloat(row[20])||0 } }; 
                }); 
            };
            const processFiles = () => { const studentMap = {}; let processedCount = 0; let activeFiles = files.map((f, i) => ({file: f, index: i})).filter(item => item.file); if (activeFiles.length === 0) { onDataUpdate(null, cutoffs); onClose(); return; } activeFiles.forEach(({file, index}) => { if (file.name.endsWith('.xls') || file.name.endsWith('.xlsx')) { const reader = new FileReader(); reader.onload = (e) => { const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'}); const rows = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1}); parseAndMerge(studentMap, rows, index); processedCount++; if (processedCount === activeFiles.length) { onDataUpdate(Object.values(studentMap), cutoffs); onClose(); } }; reader.readAsArrayBuffer(file); } else { Papa.parse(file, { header: false, complete: (res) => { parseAndMerge(studentMap, res.data, index); processedCount++; if (processedCount === activeFiles.length) { onDataUpdate(Object.values(studentMap), cutoffs); onClose(); } } }); } }); };
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 overflow-y-auto">
                    <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl p-6 my-10"><div className="flex justify-between items-center mb-6 border-b pb-4"><h2 className="text-2xl font-bold text-gray-800">ğŸ“Š æ•°æ®å¯¼å…¥ä¸å‚æ•°è®¾ç½®</h2><button onClick={onClose} className="text-gray-500 hover:text-gray-700">âœ•</button></div><div className="grid grid-cols-12 gap-4 text-sm font-bold bg-gray-100 p-3 rounded mb-2"><div className="col-span-2">è€ƒè¯•åç§°</div><div className="col-span-2">ç‰¹æ§çº¿ (ä¸€æœ¬)</div><div className="col-span-2">æœ¬ç§‘çº¿ (äºŒæœ¬)</div><div className="col-span-4">å¯¹åº”æ•°æ®æ–‡ä»¶ (CSV/XLS/XLSX)</div><div className="col-span-2 text-center">é«˜çº§è®¾ç½®</div></div><div className="space-y-3 max-h-[60vh] overflow-y-auto pr-2">{EXAM_CONFIG.map((exam, idx) => (<div key={exam.id} className="border-b pb-2"><div className="grid grid-cols-12 gap-4 items-center"><div className="col-span-2 text-gray-700 font-medium truncate" title={exam.name}>{exam.name}</div><div className="col-span-2"><input type="number" value={cutoffs[idx].special} onChange={(e) => handleCutoffChange(idx, 'special', e.target.value)} className="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500"/></div><div className="col-span-2"><input type="number" value={cutoffs[idx].bachelor} onChange={(e) => handleCutoffChange(idx, 'bachelor', e.target.value)} className="w-full border rounded px-2 py-1 focus:ring-2 focus:ring-blue-500"/></div><div className="col-span-4"><input type="file" accept=".csv,.xls,.xlsx" onChange={(e) => handleFileChange(idx, e)} className="w-full text-xs text-gray-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/></div><div className="col-span-2 text-center"><button onClick={() => setExpandedExamId(expandedExamId === idx ? null : idx)} className={`text-xs px-3 py-1 rounded border transition ${expandedExamId === idx ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-300 hover:bg-gray-50'}`}><Icons.Settings size={12} className="inline mr-1"/>{expandedExamId === idx ? 'æ”¶èµ·' : 'å„ç§‘çº¿'}</button></div></div>{expandedExamId === idx && (<div className="mt-3 bg-blue-50 p-3 rounded-lg grid grid-cols-3 md:grid-cols-5 gap-3 animate-fade-in"><div className="col-span-full text-xs text-blue-600 font-bold mb-1">è®¾ç½® {exam.name} çš„å„ç§‘æœ‰æ•ˆåˆ†ï¼š</div>{SUBJECTS.map(sub => (<div key={sub} className="flex items-center"><label className="text-xs text-gray-600 mr-2 w-8">{sub}</label><input type="number" value={(cutoffs[idx].subjects || EXAM_CONFIG[idx].defaultSubs)[sub]} onChange={(e) => handleSubjectLineChange(idx, sub, e.target.value)} className="w-16 border rounded px-1 text-sm focus:ring-1 focus:ring-blue-500"/></div>))}</div>)}</div>))}</div><div className="mt-8 flex justify-end gap-4 border-t pt-4"><button onClick={onClose} className="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">å–æ¶ˆ</button><button onClick={processFiles} className="px-6 py-2 bg-blue-600 text-white font-bold rounded hover:bg-blue-700 shadow-lg flex items-center"><Icons.Check size={18} className="mr-2"/> ç¡®è®¤å¤„ç†</button></div></div></div>
            );
        };

        const defaultCutoffs = () => EXAM_CONFIG.map(e => ({ special: e.defaultSpecial, bachelor: e.defaultBachelor, subjects: { ...e.defaultSubs } }));

        const App = () => {
            const [students, setStudents] = useState(DEMO_STUDENTS);
            const [cutoffs, setCutoffs] = useState(defaultCutoffs());
            const [showModal, setShowModal] = useState(false);
            const [view, setView] = useState('dashboard');
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [dataSource, setDataSource] = useState('demo'); // 'demo' | 'api'
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                fetch('/api/data').then(r => r.ok ? r.json() : Promise.reject()).then(data => {
                    if (data.students && data.students.length >= 0 && data.cutoffs && data.cutoffs.length === 6) {
                        setStudents(data.students);
                        setCutoffs(data.cutoffs);
                        setDataSource('api');
                    }
                }).catch(() => {}).finally(() => setLoading(false));
            }, []);

            const handleDataUpdate = (newStudents, newCutoffs) => { if(newCutoffs) setCutoffs(newCutoffs); if(newStudents) setStudents(newStudents); };
            const handlePrint = () => { if (dataSource === 'demo' && !confirm("å½“å‰æ˜¯æ¼”ç¤ºæ•°æ®ï¼Œæ˜¯å¦ç»§ç»­æ‰“å°ï¼Ÿ")) return; window.print(); };

            return (
                <div className="min-h-screen pb-10">
                    <DataUploadModal isOpen={showModal} onClose={() => setShowModal(false)} initialCutoffs={cutoffs} onDataUpdate={handleDataUpdate}/>
                    <nav className="bg-white border-b sticky top-0 z-40 glass-effect no-print px-4 h-16 flex justify-between items-center shadow-sm">
                        <div className="flex items-center text-blue-700 font-bold text-xl tracking-tight">ğŸ“Š é«˜33ç­åˆ†æç³»ç»Ÿ</div>
                        <div className="flex gap-3">
                            <button onClick={() => setView('dashboard')} className={`px-4 py-2 rounded font-medium text-sm transition ${view==='dashboard'?'bg-blue-50 text-blue-700':'text-gray-600 hover:bg-gray-50'}`}>æ•°æ®å¤§å±</button>
                            <button onClick={() => setView('leaderboard')} className={`px-4 py-2 rounded font-medium text-sm transition ${view==='leaderboard'?'bg-blue-50 text-blue-700':'text-gray-600 hover:bg-gray-50'}`}>æˆç»©æ€»è¡¨</button>
                            <button onClick={() => setView('subject')} className={`px-4 py-2 rounded font-medium text-sm transition ${view==='subject'?'bg-blue-50 text-blue-700':'text-gray-600 hover:bg-gray-50'}`}>å„ç§‘åˆ†æ</button>
                            <div className="w-px h-6 bg-gray-300 mx-1 self-center"></div>
                            <button onClick={() => setShowModal(true)} className="flex items-center text-gray-600 hover:text-blue-600 px-3 py-2 rounded text-sm font-medium"><Icons.Upload size={16} className="mr-2"/> å¯¼å…¥æ•°æ®</button>
                            <a href="admin.html" target="_blank" className="flex items-center text-gray-500 hover:text-gray-700 px-3 py-2 rounded text-sm font-medium" title="ç®¡ç†åå°">âš™ï¸</a>
                            <button onClick={handlePrint} className="flex items-center bg-blue-600 text-white px-4 py-2 rounded text-sm font-bold hover:bg-blue-700 shadow transition"><Icons.Printer size={16} className="mr-2"/> æ‰¹é‡æ‰“å°</button>
                        </div>
                    </nav>
                    {loading && <div className="fixed inset-0 bg-white/80 flex items-center justify-center z-50"><div className="text-gray-500">åŠ è½½ä¸­...</div></div>}
                    <main className="max-w-7xl mx-auto px-4 py-8 no-print">
                        {view === 'dashboard' && <Dashboard allStudents={students} cutoffs={cutoffs} onStudentClick={(s)=>{setSelectedStudent(s); setView('student');}}/>}
                        {view === 'leaderboard' && <Leaderboard allStudents={students} cutoffs={cutoffs} onStudentClick={(s)=>{setSelectedStudent(s); setView('student');}}/>}
                        {view === 'subject' && <SubjectAnalysis allStudents={students} cutoffs={cutoffs} />}
                        {view === 'student' && selectedStudent && (
                            <div className="fixed inset-0 bg-slate-50 z-50 overflow-y-auto">
                                <StudentReportScreen student={selectedStudent} cutoffs={cutoffs} allStudents={students} onBack={() => setView('leaderboard')} />
                            </div>
                        )}
                    </main>
                    <div className="print-only">
                        <div className="print-container">
                            {students.map(s => (
                                <div key={s.id} className="print-group">
                                    <ReportPage student={s} cutoffs={cutoffs} allStudents={students}/>
                                    <ReportPageTwo student={s} />
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>